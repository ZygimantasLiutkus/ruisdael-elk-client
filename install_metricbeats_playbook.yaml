---
- name: Installing the monitoring software
  hosts: all
  tasks:
    - name: Add the beats repository to apt
      ansible.builtin.apt_key:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present
      become: true
    - name: Install metricbeat
      ansible.builtin.apt:
          name: metricbeat
      become: true
    - name: Edit the metricbeat.yml to connect it to kibana and elastic search
      template:
        src: metricbeat.yml.j2
        dest: /etc//metricbeat.yml
      become: true
    - name: Enable the metricbeat service
      ansible.builtin.systemd:
        name: metricbeat
        enabled: true
      become: true
    - name: Run metricbeats
      ansible.builtin.systemd:
        name: metricbeat
        state: started
      become: true
...
